[ProtocolWrapper]
CubePump protocol runs via WebSocket.
Except [HandShake], [LoginAccept], [Ping] and [Disconnect], all other signals are delivered in packages per 50ms, encoded by:
	length uint32
	deflated byte[length]
Where deflated is the following data encoded in zlib deflation:
	size uint32
	for i from 1 to size
		signalId[i] uint16
		signalPayload[i] dynamic

[Legend]
CS = Client -> Server only
SC = Server -> Client only
MT = Signal may be sent from both sides

nop = add some bits to pad the payload to a full byte

[DataTypes]
struct string
	length uint16
	buffer byte[length]
struct string32
	length uint32
	buffer byte[length]

struct event_time
	time uint64 ; number of microseconds since SPAWN happens

struct int_pos
	x int32
	y int32
	z int32
struct float_pos
	x float32
	y float32
	z float32

struct cube_pos
	batch int_pos
	local_x nibble
	local_y nibble
	local_z nibble
	nop
struct cube_precise_pos
	batch int_pos
	local_x nibble
	local_y nibble
	local_z nibble
	face nibble
	precise_x float32
	precise_y float32

struct cube_model
	TODO

struct flex_pos
	batch int_pos
	local float_pos
	yaw float32
	pitch float32

[FlowChart]
digraph FlowChart
	initial -> login_requested [HandShake]
	login_requested -> loading [LoginAccept]
	login_requested -> disconnected [Disconnect]
	loading -> loading [Load]
	loading -> loading [Ping]
	loading -> spawned [Spawn]
	loading -> disconnected [Disconnect]
	spawned -> spawned [Load]
	spawned -> spawned [GamePlay]
	spawned -> spawned [Ping]
	spawned -> disconnected [Disconnect]
	spawned -> loading [WorldSwitch]

[HandShake]
CS LOGIN_REQUEST
	majorProtocol uint32 ; client.major == server.major
	minorProtocol uint32 ; client.minor >= server.minor
	username string
	userId byte[20]
	language string
	sysInfo string

[LoginAccept]
SC LOGIN_ACCEPT
	minorProtocol uint32 ; to let client decide if server supports new features

[Disconnect]
SC DISCONNECT
	reason string
	rejoin bool
	nop

CS DISCONNECT

[Ping]
MT PING
	lastCycle uint64
MT PONG

[Load]
SC CUBE_DICT
	size uint32
	for i from 1 to size
		cubeDefId[i] uint32
		cubeDefName[i] string
		if cubeDefName[i] does not start with "CubePump."
			cubeDefModel[i] cube_model

SC CUBE_BATCH
	pos int_pos
	payload uint32[4096]

[Spawn]
SC SPAWN
	pos flex_pos
	; also resets eventTime to uint64(0)

[GamePlay]
SC CUBE_UPDATE
	pos cube_pos
	new uint16

CS CUBE_INTERACT
	pos cube_precise_pos
	method uint16

SC FLEX_MOTION
	eventTime event_time
	new flex_pos
	velocity float_pos

CS USER_MOTION
	yaw float32
	dash bool
	nop

CS USER_ROTATION
	yaw float32
	pitch float32

CS USER_FLAGS
	flyUp bool
	flyDown bool
	freeFly bool
	float bool
	crouch bool
	nop

SC FLEX_FLAGS
	crouch bool
